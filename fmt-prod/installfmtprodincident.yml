---
 - hosts: all
   user: ubuntu

   tasks:

    - name: Pull new image
	  command: sudo sh -c "sudo docker pull selkirksystems/fmt-incidentpoller:0.0.4"
      ignore_errors: True
   
    - name: Stop old container
	  command: sudo sh -c "sudo docker stop $(sudo docker ps -a -q)"
      register: result
      ignore_errors: True


    - name: remove old container
	  command: sudo sh -c "sudo docker rm $(sudo docker ps -a -q)"
      ignore_errors: True
      when: result|success


    - name: remove old image
	  command: sudo sh -c "sudo docker rmi selkirksystems/fmt-incidentpoller:0.0.3"
      ignore_errors: True
      when: result|success


    - name: Launch new container
      command: sudo sh -c "sudo docker run -h $(ifconfig eth0 | grep 'inet addr:' | cut -d':' -f2 | awk '{print $1}')  --name incidentpoller -p 8080:8080 -e "spring.profiles.active=amazon-prod" -d selkirksystems/fmt-incidentpoller:0.0.4"



